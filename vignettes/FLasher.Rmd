---
title:  "Projecting fish populations in FLR with FLasher"
author: Iago Mosqueira & Finlay Scott - European Commission Joint Research Center
date: "`r format(as.Date(system('git log -1 --format=%ci FLasher.Rmd', intern=TRUE)), '%B %Y')`"
tags: [FLR, forecast, MSE]
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Projecting fish populations in FLR with FLasher}
  \usepackage[utf8]{inputenc}
abstract:
license: European Union Public Licence (EUPL) V.1.1
---

```{r, pkgs, echo=FALSE, message=FALSE}
library(FLasher)
library(ggplotFL)
library(knitr)
opts_chunk$set(dev='png', cache=FALSE, fig.width=5, fig.height=4.5, tidy=TRUE, dpi=300)
options(width=60)
```

# Introduction

# Setting up targets and limits


```{r fwdc}
target <- data.frame(year=2009:2019, quant="catch", value=12000)
```

```{r fwdc0, comment = "", echo = FALSE}
show(head(target))
```

```{r fwdc1}
fwc <- fwdControl(target=target)
```

```{r fwdc2, comment = "", echo = FALSE}
show(head(fwc))
```

# Projecting Operating Models: FLBiols + FLFisheries

# Projecting the stock assessment results: FLStock + FLSR

Forecasting a fish population can also be part of the Management Procedure. If a stock assessment is used to provide the necessary indicator or indicators of stock status and/or trends, the model population generally needs to be projected forward to determine the output for both stock and fishery of the HCR decision. Outside of the MSE process, population models from stock assessment are used to predict the expected im[pact of a range of management options, from different levels of catch to the consequences of bringing biomass to a given level.

The stock assessment view of the fishery system is represented in FLR by the `FLStock` class. `FLStock` objects can be projected for the same range of targets and limits presented above. Once a model has been fitted, the class contains the estimated abundances and fishing mortalities, the biological variables of the stock, such as weights, maturity and natural mortality, and the observed catches. There is one extra bit of information required to project the population, an stock-recruitment relationship as an specific model formulation and the estimated parameters.

Our example data set comes from a XSA-based stock assessment of North Sea plaice (*Pleuronectes platessa*), as carried out in 2009. Inputs include the estimated landings and discards at age, observed weights at age, and assumed values for maturity and natural mortality.

```{r, ple4, fig.cap="Time series of recruitment, spawnming stock biomass (SSB), total catch and fishing mortality from the 2009 stock assessment of North Sea plaice (ICES, 2009)."}
data(ple4)

plot(ple4)
```

As the stock assessement model applied did not estimate an stock-recruit relationship, we will fit one based on the estimated vectors of recruitment and SSB. We use the `FLSR` class and methods by converting the `FLStock` object, choosing a functional form for the stock-recruit relationship, in this case the Beverton & Holt model, and then fitting it using maximum likelihood with the `fmle` method.

```{r ple4sr, results='hide'}
fsr <- as.FLSR(ple4, model="bevholt")
fsr <- fmle(fsr)
# fsr <- fmle(fsr, method="L-BFGS-B", lower=c(0.0001, 0.00001), upper=c(Inf, Inf))
```

```{r ple4srp, fig.cap="Fit of the stock-recruit relationship for North Sea plaice."}
plot(fsr)
```

```{r fls1, results="hide"}
fls <- stf(ple4, 5)

control <- fwdControl(data.frame(year=2009:2013, quant="f", value=c(fbar(ple4)[,"2008"]),
  minAge=2, maxAge=6))

fls1 <- fwd(fls, control=control, sr=fsr)
```

```{r fls1p}
plot(fls1) + geom_vline(aes(xintercept=2009), linetype=2, colour="red")
```

```{r, eval=FALSE}

# BIOL
PLE=as(ple4, "FLBiol")
rec(PLE) <- predictModel(model=model(fsr), params=params(fsr))

# BIOLS
biols <- FLBiols(PLE=PLE)

# FISHERY
BT <- as(ple4, 'FLFishery')
names(BT) <- "PLE"

# FISHERIES
fisheries <- FLFisheries(BT=BT)

# HINDCASTING
control <- fwdControl(data.frame(year=2000:2008, quant="catch", value=c(catch(ple4)[,(44:52)])))


control <- fwdControl(data.frame(year=2000:2008, quant="f", value=c(fbar(ple4)[,(44:52)]),
  minAge=2, maxAge=6))

# 
residuals <- FLQuants(PLE=window(residuals(fsr), start=1957))
residuals[[1]][,1]<-1


target <- data.frame(year=2009:2019, quant="catch", value=12000)
control <- fwdControl(target=target)


# FLB + FLF
res <- fwd(biols, fisheries, control, residuals)

res <- fwd(biols, fisheries[[1]], control, residuals)

res <- fwd(biols[[1]], fisheries, control, residuals)

res <- fwd(biols, fisheries, control)

res <- fwd(biols, fisheries, control, residuals=residuals)

#

res <- fwd(ple4, control=control, residuals=residuals[[1]], sr=fsr)

res <- fwd(ple4, control=control, sr=fsr)

res <- fwd(ple4, sr=fsr, catch=FLQuant(1000, dimnames=list(year=1990:1995)))
```



# References

